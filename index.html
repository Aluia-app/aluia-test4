<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AluIA - Supporto Psicologico</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#E8F4FD 0%,#F0F8FF 50%,#E8F4FD 100%);min-height:100vh;padding:20px;transition:.3s}
    body.dark-mode{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%)}
    .container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:30px;align-items:start}
    @media(max-width:768px){.container{grid-template-columns:1fr;gap:20px}}
    .card{background:rgba(255,255,255,.98);border-radius:20px;padding:30px;box-shadow:0 8px 32px rgba(0,0,0,.06);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.8)}
    body.dark-mode .card{background:rgba(52,73,94,.95);color:#ecf0f1;border:1px solid rgba(255,255,255,.1)}
    .header{text-align:center;margin-bottom:30px;grid-column:1 / -1}
    .header h1{font-size:3rem;color:#4A90E2;margin-bottom:10px;font-weight:600}
    body.dark-mode .header h1{color:#74b9ff}
    .header p{font-size:1.2rem;color:#7B8FA3}
    body.dark-mode .header p{color:#bdc3c7}
    .status-bar{position:fixed;top:20px;right:20px;background:#FF9500;color:#fff;padding:10px 20px;border-radius:25px;font-weight:700;z-index:1000;backdrop-filter:blur(10px);box-shadow:0 4px 12px rgba(255,149,0,.3)}
    .status-bar.connected{background:#4CAF50}
    .status-bar.elevenlabs{background:#9C27B0}
    .warn-bar{position:fixed;left:50%;transform:translateX(-50%);top:80px;background:#e53935;color:#fff;padding:10px 16px;border-radius:10px;z-index:1100;display:none}
    .theme-toggle{position:fixed;top:20px;left:20px;background:rgba(255,255,255,.95);border:none;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;backdrop-filter:blur(10px);z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    body.dark-mode .theme-toggle{background:rgba(52,73,94,.9)}
    .section-title{font-size:1.5rem;color:#4A90E2;margin-bottom:20px;display:flex;align-items:center;gap:10px;font-weight:600}
    body.dark-mode .section-title{color:#74b9ff}
    .microphone-section{text-align:center}
    .microphone-button{width:120px;height:120px;border-radius:50%;background:#4A90E2;border:none;color:#fff;font-size:2.5rem;cursor:pointer;margin:20px auto;display:block;box-shadow:0 8px 24px rgba(74,144,226,.3)}
    .microphone-button.listening{background:#e74c3c;animation:pulse 2s infinite}
    .microphone-button.disabled{background:#95a5a6}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}
    .microphone-status{background:rgba(74,144,226,.1);border:2px solid #4A90E2;border-radius:25px;padding:15px;margin:20px 0;font-weight:600;color:#4A90E2}
    .microphone-status.active{background:rgba(76,175,80,.1);border-color:#4CAF50;color:#4CAF50}
    .microphone-status.disabled{background:rgba(149,165,166,.1);border-color:#95a5a6;color:#95a5a6}
    .transcript-area{background:rgba(248,249,250,.8);border:2px dashed #D1D9E0;border-radius:15px;padding:20px;min-height:100px;margin:20px 0;font-style:italic;color:#7B8FA3}
    .transcript-area.has-content{background:rgba(74,144,226,.05);border-color:#4A90E2;color:#2c3e50;font-style:normal}
    .microphone-help{background:rgba(255,193,7,.08);border:1px solid #FFE082;border-radius:15px;padding:15px;margin:20px 0;font-size:.9rem}
    .chat-section{display:flex;flex-direction:column;height:600px}
    .chat-container{flex:1;background:rgba(248,249,250,.6);border-radius:15px;padding:20px;overflow-y:auto;margin-bottom:20px;border:1px solid rgba(0,0,0,.05)}
    .message{margin:15px 0;padding:15px 20px;border-radius:20px;max-width:80%;word-wrap:break-word}
    .message.user{background:#4A90E2;color:#fff;margin-left:auto;border-bottom-right-radius:5px}
    .message.assistant{background:rgba(248,249,250,.95);color:#2c3e50;margin-right:auto;border-bottom-left-radius:5px;border:1px solid rgba(74,144,226,.1)}
    .typing-indicator{display:none;align-items:center;gap:10px;padding:15px 20px;background:rgba(248,249,250,.95);border-radius:20px;border-bottom-left-radius:5px;max-width:80%;margin:15px 0;border:1px solid rgba(74,144,226,.1)}
    .typing-dots{display:flex;gap:4px}
    .typing-dots span{width:8px;height:8px;background:#4A90E2;border-radius:50%;animation:typing 1.4s infinite ease-in-out}
    .typing-dots span:nth-child(1){animation-delay:-.32s}.typing-dots span:nth-child(2){animation-delay:-.16s}
    @keyframes typing{0%,80%,100%{transform:scale(.8);opacity:.5}40%{transform:scale(1);opacity:1}}
    .chat-input-container{display:flex;gap:10px;align-items:center}
    .chat-input{flex:1;padding:15px 20px;border:2px solid #FFE082;border-radius:25px;font-size:1rem;background:rgba(255,255,255,.95)}
    .send-button{background:#4A90E2;color:#fff;border:none;border-radius:50%;width:50px;height:50px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700}
    .privacy-button{background:rgba(255,149,0,.1);border:2px solid #FF9500;color:#FF9500;padding:15px 30px;border-radius:25px;cursor:pointer;font-weight:700;margin:20px auto;display:block}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:2000;backdrop-filter:blur(5px)}
    .modal-content{background:#fff;margin:5% auto;padding:30px;border-radius:20px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto;position:relative}
    .close{position:absolute;top:15px;right:20px;font-size:2rem;cursor:pointer;color:#95a5a6}
    .admin-button{display:none;position:fixed;bottom:20px;right:20px;background:rgba(52,73,94,.9);color:#fff;border:none;border-radius:50%;width:60px;height:60px;font-size:1.5rem;cursor:pointer;z-index:1000}
    .toast{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) translateY(20px);background:rgba(76,175,80,.95);color:#fff;padding:20px 30px;border-radius:15px;font-weight:700;z-index:3000;opacity:0;transition:.3s}
    .toast.error{background:rgba(244,67,54,.95)} .toast.show{opacity:1;transform:translate(-50%,-50%) translateY(0)}
    @media(max-width:480px){body{padding:10px}.card{padding:20px}.header h1{font-size:2rem}.microphone-button{width:100px;height:100px;font-size:2rem}.chat-section{height:500px}.message{max-width:90%}}
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">üåô</button>
  <div class="status-bar" id="statusBar">‚ö†Ô∏è Modalit√† Demo</div>
  <div class="warn-bar" id="warnBar"></div>
  <button class="admin-button" id="adminBtn">‚öôÔ∏è</button>

  <div class="container">
    <div class="header card">
      <h1>AluIA</h1>
      <p>Supporto psicologico intelligente sempre al tuo fianco</p>
    </div>

    <div class="card">
      <h2 class="section-title">üé§ Comunicazione Vocale</h2>
      <div class="microphone-section">
        <button class="microphone-button" id="microphoneButton" aria-pressed="false">üé§</button>
        <div class="microphone-status" id="microphoneStatus">Clicca üé§ per abilitare il microfono</div>
        <div class="transcript-area" id="transcriptArea">La trascrizione in tempo reale apparir√† qui...</div>
        <div class="microphone-help">
          <h4>üîì Come sbloccare il microfono:</h4>
          <ol>
            <li>Usa la pagina in <strong>HTTPS</strong> (o <code>localhost/127.0.0.1</code> in sviluppo).</li>
            <li>Clicca il <strong>lucchetto</strong> nella barra e consenti il microfono.</li>
            <li>Se richiesto, <strong>ricarica</strong> dopo aver concesso il permesso.</li>
          </ol>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="section-title">üí¨ Chat con Alu</h2>
      <div class="chat-section">
        <div class="chat-container" id="chatContainer">
          <div class="message assistant">üëã Ciao! Sono Alu. Parla con me (üé§) o scrivi qui sotto. Come posso supportarti oggi?</div>
          <div class="typing-indicator" id="typingIndicator"><span>Alu sta scrivendo</span><div class="typing-dots"><span></span><span></span><span></span></div></div>
        </div>
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="chatInput" placeholder="Scrivi il tuo messaggio..." />
          <button class="send-button" id="sendButton">Invia</button>
        </div>
      </div>
    </div>

    <button class="privacy-button" id="privacyButton">üîí Privacy & Sicurezza</button>
  </div>

  <!-- Privacy Modal -->
  <div class="modal" id="privacyModal">
    <div class="modal-content">
      <span class="close" id="closePrivacy">&times;</span>
      <h2>üîí Privacy & Sicurezza</h2>
      <p><strong>Non salviamo</strong> le conversazioni: restano nel tuo browser per questa sessione.</p>
    </div>
  </div>

  <!-- Admin Modal -->
  <div class="modal" id="adminModal">
    <div class="modal-content">
      <span class="close" id="closeAdmin">&times;</span>
      <h2>‚öôÔ∏è Configurazione Amministratore</h2>
      <div class="admin-form">
        <label for="apiKey">OpenAI API Key:</label>
        <input type="password" id="apiKey" placeholder="sk-..." />
        <label for="elevenLabsKey">ElevenLabs API Key (opzionale):</label>
        <input type="password" id="elevenLabsKey" placeholder="sk_..." />
        <label for="assistantId">Assistant ID (opzionale):</label>
        <input type="text" id="assistantId" placeholder="asst_..." />
        <label for="voiceId">Voice ID ElevenLabs:</label>
        <select id="voiceId">
          <option value="">Usa sintesi nativa</option>
          <option value="IyWqvgbFwm4IK1x6M489" selected>Voce personalizzata (IyWqvgbFwm4IK1x6M489)</option>
          <option value="21m00Tcm4TlvDq8ikWAM">Rachel (EN - F)</option>
          <option value="AZnzlk1XvdvUeBnXmlld">Domi (EN - F)</option>
          <option value="EXAVITQu4vr4xnSDxMaL">Bella (EN - F)</option>
          <option value="ErXwobaYiN019PkySvjV">Antoni (EN - M)</option>
          <option value="MF3mGyEYCl7XYWbV9V6O">Elli (EN - F)</option>
          <option value="TxGEqnHWrfWFTfGW9XjX">Josh (EN - M)</option>
        </select>
        <button onclick="window.aluia.saveAdminConfig()">Salva Configurazione</button>
      </div>
    </div>
  </div>

  <script>
    /***************
     * Utils + mini test harness
     ***************/
    function isSecureLikeContext() {
      const { protocol, hostname } = location;
      if (protocol === 'https:') return true;
      if (hostname === 'localhost' || hostname === '127.0.0.1') return true;
      return false; // include file:// come non sicuro
    }
    function mapGetUserMediaError(err) {
      const name = err?.name || err?.code || 'UnknownError';
      switch (name) {
        case 'NotAllowedError':
        case 'PermissionDeniedError':
          return 'Permesso microfono negato. Concedilo dal lucchetto del browser e ricarica.';
        case 'NotFoundError':
        case 'DevicesNotFoundError':
          return 'Nessun microfono rilevato. Collega un microfono e riprova.';
        case 'NotReadableError':
          return 'Il microfono √® occupato da un‚Äôaltra app. Chiudila e riprova.';
        case 'OverconstrainedError':
          return 'Le impostazioni audio richieste non sono supportate da questo dispositivo.';
        case 'SecurityError':
          return 'La pagina deve essere in HTTPS (o localhost).';
        default:
          return 'Impossibile accedere al microfono.';
      }
    }
    function evalMicPrereq(ctx) {
      const { protocol, hostname, isSecure, hasMediaDevices } = ctx;
      if (!hasMediaDevices) return 'no-media-devices';
      const secure = (protocol === 'https:') || (hostname === 'localhost') || (hostname === '127.0.0.1') || isSecure;
      if (!secure) return 'insecure-context';
      return 'ok';
    }
    (function runPrereqTests(){
      const cases = [
        { in:{protocol:'http:',hostname:'example.com',isSecure:false,hasMediaDevices:true}, out:'insecure-context' },
        { in:{protocol:'http:',hostname:'localhost',isSecure:false,hasMediaDevices:true}, out:'ok' },
        { in:{protocol:'https:',hostname:'site.com',isSecure:true,hasMediaDevices:true}, out:'ok' },
        { in:{protocol:'https:',hostname:'site.com',isSecure:true,hasMediaDevices:false}, out:'no-media-devices' },
        { in:{protocol:'file:',hostname:'',isSecure:false,hasMediaDevices:true}, out:'insecure-context' },
        { in:{protocol:'http:',hostname:'127.0.0.1',isSecure:false,hasMediaDevices:true}, out:'ok' }
      ];
      let pass=0; cases.forEach((c,i)=>{ const got=evalMicPrereq(c.in); const ok=got===c.out; console.log(`TEST[${i}]`,ok?'PASS':'FAIL',{expected:c.out,got,input:c.in}); if(ok) pass++; });
      console.log(`Tests passed ${pass}/${cases.length}`);
    })();

    /***************
     * App
     ***************/
    class AluIA {
      constructor() {
        // Stato
        this.recognition = null;
        this.isListening = false;
        this.isProcessing = false;
        this.isSpeaking = false;
        this.conversationHistory = [];
        this.ignoreAsrUntil = 0;
        this.postTtsCooldownMs = 900;
        this.userConsented = false;
        this.wasListeningPreTts = false;
        this.resumeAfterTts = false;
        this._italianVoice = null;

        // Config
        this.isDarkMode = localStorage.getItem('aluia_theme') === 'dark';
        this.apiKey = localStorage.getItem('aluia_api_key') || '';
        this.elevenLabsKey = localStorage.getItem('aluia_elevenlabs_key') || '';
        this.assistantId = localStorage.getItem('aluia_assistant_id') || '';
        this.voiceId = localStorage.getItem('aluia_voice_id') || 'IyWqvgbFwm4IK1x6M489';
        this.isApiConfigured = !!this.apiKey;
        this.isElevenLabsConfigured = !!this.elevenLabsKey;

        // DOM
        this.cacheEls();
        this.applyTheme();
        this.updateUI();
        this.initEvents();

        // Setup (no autostart mic)
        this.initSpeechRecognition();
        this.initVoicesOnce();
        this.warnIfInsecure();
      }

      cacheEls() {
        this.themeToggle = document.getElementById('themeToggle');
        this.statusBar = document.getElementById('statusBar');
        this.warnBar = document.getElementById('warnBar');
        this.microphoneButton = document.getElementById('microphoneButton');
        this.microphoneStatus = document.getElementById('microphoneStatus');
        this.transcriptArea = document.getElementById('transcriptArea');
        this.chatContainer = document.getElementById('chatContainer');
        this.chatInput = document.getElementById('chatInput');
        this.sendButton = document.getElementById('sendButton');
        this.typingIndicator = document.getElementById('typingIndicator');
        this.adminBtn = document.getElementById('adminBtn');
        this.privacyModal = document.getElementById('privacyModal');
        this.adminModal = document.getElementById('adminModal');
      }

      supportsGetUserMedia(){ return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia); }
      warnIfInsecure(){
        const pre = evalMicPrereq({ protocol:location.protocol, hostname:location.hostname, isSecure:window.isSecureContext, hasMediaDevices:this.supportsGetUserMedia() });
        if (pre==='insecure-context') this.showWarn('Per usare il microfono serve HTTPS (oppure localhost/127.0.0.1).');
        else if (pre==='no-media-devices') this.showWarn('Questo browser non espone navigator.mediaDevices/getUserMedia.');
      }

      initEvents() {
        this.themeToggle?.addEventListener('click', () => this.toggleTheme());
        this.microphoneButton?.addEventListener('click', () => this.handleMicButton());
        this.sendButton?.addEventListener('click', () => this.sendMessage());
        this.chatInput?.addEventListener('keypress', (e)=>{ if(e.key==='Enter') this.sendMessage(); });

        document.addEventListener('dblclick', (e) => {
          if (e.target === document.body) {
            const code = prompt('Codice amministratore:');
            if (code === 'ALUIA2025') { this.adminBtn.style.display = 'block'; this.showToast('Modalit√† amministratore attivata'); }
          }
        });
        this.adminBtn?.addEventListener('click', () => this.showAdminModal());
        document.getElementById('closeAdmin')?.addEventListener('click', () => this.hideAdminModal());
        document.getElementById('privacyButton')?.addEventListener('click', () => this.showPrivacyModal());
        document.getElementById('closePrivacy')?.addEventListener('click', () => this.hidePrivacyModal());

        // Opzione A: non auto-ripartire quando torni sulla tab
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) this.stopListening();
          // Quando torna visibile: non fare nulla (rimane off finch√© l'utente non clicca).
        });
      }

      applyTheme(){ document.body.classList.toggle('dark-mode', this.isDarkMode); this.themeToggle.textContent = this.isDarkMode?'‚òÄÔ∏è':'üåô'; }
      toggleTheme(){ this.isDarkMode=!this.isDarkMode; localStorage.setItem('aluia_theme', this.isDarkMode?'dark':'light'); this.applyTheme(); this.showToast(`Tema ${this.isDarkMode?'scuro':'chiaro'} attivato`); }

      updateUI(){
        if (this.isElevenLabsConfigured && this.voiceId) { this.statusBar.textContent='‚úÖ Alu Pronta (AI + Voice)'; this.statusBar.className='status-bar elevenlabs'; }
        else if (this.isApiConfigured) { this.statusBar.textContent='‚úÖ Alu Pronta (API)'; this.statusBar.className='status-bar connected'; }
        else { this.statusBar.textContent='‚ö†Ô∏è Modalit√† Demo'; this.statusBar.className='status-bar'; }
      }

      showWarn(msg){ this.warnBar.textContent=msg; this.warnBar.style.display='block'; }
      showToast(message,type='success'){ const t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=message; document.body.appendChild(t); setTimeout(()=>t.classList.add('show'),50); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),300);},3000); }

      showPrivacyModal(){ this.privacyModal.style.display='block'; }
      hidePrivacyModal(){ this.privacyModal.style.display='none'; }
      showAdminModal(){ document.getElementById('apiKey').value=this.apiKey; document.getElementById('elevenLabsKey').value=this.elevenLabsKey; document.getElementById('assistantId').value=this.assistantId; document.getElementById('voiceId').value=this.voiceId; this.adminModal.style.display='block'; }
      hideAdminModal(){ this.adminModal.style.display='none'; }
      saveAdminConfig(){
        const apiKey=document.getElementById('apiKey').value.trim();
        const eleven=document.getElementById('elevenLabsKey').value.trim();
        const asst=document.getElementById('assistantId').value.trim();
        const voice=document.getElementById('voiceId').value.trim();
        if (apiKey && !apiKey.startsWith('sk-')) return this.showToast('OpenAI API Key non valida (deve iniziare con sk-)', 'error');
        if (eleven && !eleven.startsWith('sk_')) return this.showToast('ElevenLabs API Key non valida (deve iniziare con sk_)', 'error');
        this.apiKey=apiKey; this.elevenLabsKey=eleven; this.assistantId=asst; this.voiceId=voice||this.voiceId;
        localStorage.setItem('aluia_api_key',this.apiKey);
        localStorage.setItem('aluia_elevenlabs_key',this.elevenLabsKey);
        localStorage.setItem('aluia_assistant_id',this.assistantId);
        localStorage.setItem('aluia_voice_id',this.voiceId);
        this.isApiConfigured=!!this.apiKey; this.isElevenLabsConfigured=!!this.elevenLabsKey; this.updateUI(); this.hideAdminModal(); this.showToast('Configurazione salvata!');
      }

      // === Mic (Opzione A) ===
      async handleMicButton(){
        if (!this.supportsGetUserMedia()) return this.showToast('Browser non supporta getUserMedia', 'error');
        if (!isSecureLikeContext()) return this.showToast('Servi la pagina in HTTPS o usa localhost/127.0.0.1', 'error');

        if (!this.userConsented) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }});
            stream.getTracks().forEach(t=>t.stop()); // rilascio
            this.userConsented = true;
            this.showToast('Permesso microfono concesso');
            this.startListening(); // parte perch√© l‚Äôutente ha cliccato
          } catch (err) {
            console.error('getUserMedia failed:', err);
            this.showToast(mapGetUserMediaError(err), 'error');
            return;
          }
        } else {
          if (this.isListening) this.stopListening();
          else this.startListening();
        }
        this.updateMicUI();
      }

      initSpeechRecognition(){
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
          this.showWarn('Questo browser non supporta la Web Speech API. Prova Chrome.');
          return;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        this.recognition.continuous = true;
        this.recognition.interimResults = true;
        this.recognition.lang = 'it-IT';
        this.recognition.maxAlternatives = 1;

        this.recognition.onstart = () => { this.isListening = true; this.updateMicUI(); };
        this.recognition.onresult = (event) => {
          if (this.isSpeaking || Date.now() < this.ignoreAsrUntil) return;
          let finalTranscript='', interimTranscript='';
          for (let i=event.resultIndex;i<event.results.length;i++){
            const t=event.results[i][0].transcript;
            if (event.results[i].isFinal) finalTranscript+=t; else interimTranscript+=t;
          }
          this.transcriptArea.textContent = finalTranscript + interimTranscript;
          this.transcriptArea.classList.add('has-content');
          if (finalTranscript.trim()) this.processVoiceInput(finalTranscript.trim());
        };
        this.recognition.onerror = (e) => { console.warn('ASR error:', e); /* opzione A: nessun auto-retry */ };
        this.recognition.onend = () => { this.isListening = false; this.updateMicUI(); /* opzione A: no auto-restart */ };
      }

      startListening(){ if (this.recognition && !this.isListening) { try{ this.recognition.start(); } catch(e){ console.warn('ASR start failed',e); } } }
      stopListening(){ if (this.recognition && this.isListening) { try{ this.recognition.stop(); } catch{} } }

      // TTS pausa ASR solo se era attivo
      pauseRecognition(){
        this.wasListeningPreTts = this.isListening;
        if (this.isListening) this.stopListening();
        this.resumeAfterTts = true;
      }
      resumeRecognitionSafe(){
        setTimeout(()=>{
          if (this.resumeAfterTts && this.userConsented && this.wasListeningPreTts) {
            this.startListening(); // riparte solo se l‚Äôutente lo aveva avviato
          }
          this.resumeAfterTts = false;
          this.wasListeningPreTts = false;
        }, this.postTtsCooldownMs);
      }

      updateMicUI(){
        const btn=this.microphoneButton;
        if (!this.userConsented) {
          btn.classList.remove('listening','disabled');
          this.microphoneStatus.textContent='Clicca üé§ per abilitare il microfono';
          return;
        }
        if (this.isListening) {
          btn.classList.add('listening'); btn.classList.remove('disabled');
          btn.setAttribute('aria-pressed','true');
          this.microphoneStatus.textContent='Microfono attivo ‚Äì Parla ora';
          this.microphoneStatus.classList.add('active'); this.microphoneStatus.classList.remove('disabled');
        } else {
          btn.classList.remove('listening'); btn.classList.remove('disabled');
          btn.setAttribute('aria-pressed','false');
          this.microphoneStatus.textContent='Microfono in pausa ‚Äì clicca per riprendere';
          this.microphoneStatus.classList.remove('active'); this.microphoneStatus.classList.add('disabled');
        }
      }

      processVoiceInput(text){
        this.isProcessing = true;
        this.addMessage(text,'user');
        this.sendToAssistant(text);
        setTimeout(()=>{ this.isProcessing=false; }, 3000);
      }

      addMessage(content,type){
        const el=document.createElement('div'); el.className=`message ${type}`; el.textContent=content;
        this.chatContainer.appendChild(el); this.chatContainer.scrollTop=this.chatContainer.scrollHeight;
      }

      async sendToAssistant(message){
        this.showTyping();
        try {
          this.conversationHistory.push({role:'user',content:message});
          let response;
          if (!this.isApiConfigured) {
            response = this.getDemoResponse(message);
          } else {
            const apiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
              method:'POST',
              headers:{'Content-Type':'application/json','Authorization':`Bearer ${this.apiKey}`},
              body: JSON.stringify({
                model:'gpt-4o-mini',
                messages:[
                  {role:'system',content:'Sei Alu, un assistente di supporto psicologico empatico e professionale. Rispondi sempre in italiano con calore e comprensione. Mantieni le risposte concise ma significative (massimo 150 parole). Se rilevi situazioni di emergenza, suggerisci di contattare professionisti qualificati. Usa un tono caldo e rassicurante.'},
                  ...this.conversationHistory.slice(-10)
                ],
                max_tokens:400, temperature:0.7
              })
            });
            if (!apiResponse.ok) throw new Error(`API Error: ${apiResponse.status}`);
            const data = await apiResponse.json();
            response = data.choices?.[0]?.message?.content || this.getDemoResponse(message);
          }
          this.conversationHistory.push({role:'assistant',content:response});
          this.hideTyping();
          this.addMessage(response,'assistant');

          // TTS + anti-loop
          this.ignoreAsrUntil = Date.now() + 2000;
          if (this.isElevenLabsConfigured && this.voiceId) await this.speakWithElevenLabs(response);
          else this.speakWithNativeTTS(response);

          if (this.conversationHistory.length>40) this.conversationHistory=this.conversationHistory.slice(-20);
        } catch (e) {
          console.warn('sendToAssistant error:',e);
          this.hideTyping();
          const demo=this.getDemoResponse(message);
          this.addMessage(demo,'assistant');
          this.ignoreAsrUntil = Date.now() + 2000;
          if (this.isElevenLabsConfigured && this.voiceId) await this.speakWithElevenLabs(demo);
          else this.speakWithNativeTTS(demo);
        }
      }

      async speakWithElevenLabs(text) {
        try {
          if (!this.isElevenLabsConfigured || !this.voiceId) return this.speakWithNativeTTS(text);

          const cleanText = text.replace(/[üî•üíô‚úÖ‚ùå‚ö†Ô∏èüÜòüé§üí¨üîí]/g,'').trim() || ' ';
          const ctrl = new AbortController();
          const tid = setTimeout(() => ctrl.abort('timeout'), 12000);

          const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${this.voiceId}`, {
            method: 'POST',
            signal: ctrl.signal,
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': this.elevenLabsKey
            },
            body: JSON.stringify({
              text: cleanText,
              model_id: 'eleven_multilingual_v2',
              voice_settings: { stability: .6, similarity_boost: .7, style: .4, use_speaker_boost: true }
            })
          }).catch(err => { throw err; });

          clearTimeout(tid);

          if (!res.ok) throw new Error(`ElevenLabs API Error: ${res.status}`);

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.volume = 0.8;

          audio.onplay = () => { this.isSpeaking = true; this.pauseRecognition(); };
          audio.onended = () => { URL.revokeObjectURL(url); this.isSpeaking = false; this.resumeRecognitionSafe(); };
          audio.onerror = () => {
            URL.revokeObjectURL(url);
            this.isSpeaking = false;
            this.resumeRecognitionSafe();
            this.speakWithNativeTTS(text);
          };

          await audio.play();
        } catch (e) {
          console.warn('ElevenLabs playback error:', e);
          this.isSpeaking = false;
          this.resumeRecognitionSafe();
          this.speakWithNativeTTS(text);
          if (String(e).includes('timeout')) this.showToast('Voce esterna lenta, uso quella di sistema', 'error');
        }
      }

      // Voce nativa con supporto a voiceschanged (Safari/Chrome lazy)
      initVoicesOnce() {
        if (!('speechSynthesis' in window)) return;
        const assign = () => {
          const voices = speechSynthesis.getVoices();
          const it = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('it'));
          this._italianVoice = it || null;
        };
        assign();
        try { window.speechSynthesis.addEventListener('voiceschanged', assign, { once: true }); } catch {}
      }

      speakWithNativeTTS(text){
        if(!('speechSynthesis'in window)) return;
        speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(text);
        u.lang='it-IT'; u.rate=.85; u.pitch=1.1; u.volume=.8;
        if (this._italianVoice) u.voice = this._italianVoice;
        u.onstart=()=>{ this.isSpeaking=true; this.pauseRecognition(); };
        u.onend=()=>{ this.isSpeaking=false; this.resumeRecognitionSafe(); };
        u.onerror=()=>{ this.isSpeaking=false; this.resumeRecognitionSafe(); };
        speechSynthesis.speak(u);
      }

      getDemoResponse(message){
        const responses=[
          'Ti ascolto e capisco quello che stai vivendo. √à normale sentirsi cos√¨ a volte.',
          'Grazie per aver condiviso questo con me. Come ti senti ora dopo averlo espresso?',
          'Quello che provi √® valido e importante. Vuoi parlarmi di pi√π di questa situazione?',
          'Ti sono vicina in questo momento. Ricorda che non sei solo in questo percorso.',
          '√à un passo importante quello di parlarne. Come posso aiutarti a sentirti meglio?',
          'Comprendo la tua preoccupazione. Insieme possiamo trovare delle strategie per affrontarla.',
          'Le tue emozioni sono importanti. Prenditi il tempo che ti serve per elaborarle.',
          'Sono qui per ascoltarti senza giudicare. Cosa ti passa per la mente in questo momento?',
          'Capisco che possa essere difficile. Vuoi provare a respirare insieme per qualche minuto?',
          'La tua esperienza √® unica e preziosa. Come posso supportarti meglio oggi?'
        ];
        const lower=message.toLowerCase();
        if (lower.includes('suicid')||lower.includes('morte')||lower.includes('farla finita')) return 'Mi preoccupo molto per te. √à fondamentale che tu parli immediatamente con un professionista qualificato. Contatta il tuo medico, un centro di salute mentale o i servizi di emergenza. La tua vita ha un valore immenso e ci sono persone pronte ad aiutarti. üÜò';
        if (lower.includes('panico')||lower.includes('ansia')||lower.includes('attacco')) return 'Capisco che stai attraversando un momento molto difficile. Proviamo insieme: inspira lentamente per 4 secondi, trattieni per 4, poi espira per 6. Se gli attacchi sono frequenti, senti un professionista. Sono qui con te. üíô';
        if (lower.includes('solo')||lower.includes('abbandon')||lower.includes('isolat')) return 'Non sei davvero solo, anche se ora pu√≤ sembrare cos√¨. I sentimenti di solitudine sono dolorosi ma temporanei. Vuoi parlarmi di cosa ti fa sentire pi√π isolato?';
        return responses[Math.floor(Math.random()*responses.length)];
      }

      showTyping(){ this.typingIndicator.style.display='flex'; this.chatContainer.scrollTop=this.chatContainer.scrollHeight; }
      hideTyping(){ this.typingIndicator.style.display='none'; }
    }

    // Boot
    document.addEventListener('DOMContentLoaded', ()=>{ window.aluia = new AluIA(); });

    // Debug helper
    window.resetMic = () => { const a=window.aluia; if(!a) return; a.userConsented=false; a.stopListening(); a.updateMicUI(); a.showToast('Reset microfono completato'); };
    window.testChat = () => { const a=window.aluia; if(!a) return; a.chatInput.value='Ciao Alu, test rapido'; a.sendMessage(); };
  </script>
</body>
</html>
