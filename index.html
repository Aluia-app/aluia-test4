<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AluIA - Supporto Psicologico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E8F4FD 0%, #F0F8FF 50%, #E8F4FD 100%);
            min-height: 100vh;
            padding: 20px;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        body.dark-mode .card {
            background: rgba(52, 73, 94, 0.95);
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            grid-column: 1 / -1;
        }

        .header h1 {
            font-size: 3rem;
            color: #4A90E2;
            margin-bottom: 10px;
            text-shadow: none;
            font-weight: 600;
        }

        body.dark-mode .header h1 {
            color: #74b9ff;
        }

        .header p {
            font-size: 1.2rem;
            color: #7B8FA3;
            font-weight: 400;
        }

        body.dark-mode .header p {
            color: #bdc3c7;
        }

        .status-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #FF9500;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: none;
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
        }

        .status-bar.connected {
            background: #4CAF50;
        }

        .status-bar.elevenlabs {
            background: #9C27B0;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .theme-toggle {
            background: rgba(52, 73, 94, 0.9);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .section-title {
            font-size: 1.5rem;
            color: #4A90E2;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        body.dark-mode .section-title {
            color: #74b9ff;
        }

        .microphone-section {
            text-align: center;
        }

        .microphone-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #4A90E2;
            border: none;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(74, 144, 226, 0.3);
            position: relative;
            overflow: hidden;
        }

        .microphone-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 32px rgba(74, 144, 226, 0.4);
        }

        .microphone-button.listening {
            background: #e74c3c;
            animation: pulse 2s infinite;
            box-shadow: 0 8px 24px rgba(231, 76, 60, 0.4);
        }

        .microphone-button.disabled {
            background: #95a5a6;
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .microphone-status {
            background: rgba(74, 144, 226, 0.1);
            border: 2px solid #4A90E2;
            border-radius: 25px;
            padding: 15px;
            margin: 20px 0;
            font-weight: 600;
            color: #4A90E2;
            transition: all 0.3s ease;
        }

        body.dark-mode .microphone-status {
            background: rgba(74, 144, 226, 0.2);
            color: #74b9ff;
        }

        .microphone-status.active {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .microphone-status.disabled {
            background: rgba(149, 165, 166, 0.1);
            border-color: #95a5a6;
            color: #95a5a6;
        }

        body.dark-mode .microphone-status.active {
            color: #81C784;
        }

        .transcript-area {
            background: rgba(248, 249, 250, 0.8);
            border: 2px dashed #D1D9E0;
            border-radius: 15px;
            padding: 20px;
            min-height: 100px;
            margin: 20px 0;
            font-style: italic;
            color: #7B8FA3;
            transition: all 0.3s ease;
        }

        body.dark-mode .transcript-area {
            background: rgba(108, 117, 125, 0.2);
            color: #95a5a6;
        }

        .transcript-area.has-content {
            background: rgba(74, 144, 226, 0.05);
            border-color: #4A90E2;
            color: #2c3e50;
            font-style: normal;
        }

        body.dark-mode .transcript-area.has-content {
            color: #ecf0f1;
        }

        .microphone-help {
            background: rgba(255, 193, 7, 0.08);
            border: 1px solid #FFE082;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        body.dark-mode .microphone-help {
            background: rgba(255, 193, 7, 0.15);
        }

        .microphone-help h4 {
            color: #FF9500;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .microphone-help ol {
            margin-left: 20px;
        }

        .microphone-help li {
            margin: 5px 0;
            color: #8D6E63;
        }

        body.dark-mode .microphone-help li {
            color: #FFCC80;
        }

        .chat-section {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-container {
            flex: 1;
            background: rgba(248, 249, 250, 0.6);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .chat-container {
            background: rgba(44, 62, 80, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .message {
            margin: 15px 0;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: #4A90E2;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.assistant {
            background: rgba(248, 249, 250, 0.95);
            color: #2c3e50;
            margin-right: auto;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(74, 144, 226, 0.1);
        }

        body.dark-mode .message.assistant {
            background: rgba(52, 73, 94, 0.9);
            color: #ecf0f1;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: rgba(248, 249, 250, 0.95);
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            max-width: 80%;
            margin: 15px 0;
            border: 1px solid rgba(74, 144, 226, 0.1);
        }

        body.dark-mode .typing-indicator {
            background: rgba(52, 73, 94, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #4A90E2;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #FFE082;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
        }

        body.dark-mode .chat-input {
            background: rgba(52, 73, 94, 0.9);
            border-color: #7f8c8d;
            color: #ecf0f1;
        }

        .chat-input:focus {
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .send-button {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(74, 144, 226, 0.4);
        }

        .privacy-button {
            background: rgba(255, 149, 0, 0.1);
            border: 2px solid #FF9500;
            color: #FF9500;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            text-align: center;
        }

        body.dark-mode .privacy-button {
            background: rgba(255, 149, 0, 0.2);
            color: #FFB74D;
        }

        .privacy-button:hover {
            background: rgba(255, 149, 0, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 149, 0, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode .modal-content {
            background: #2c3e50;
            color: #ecf0f1;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #95a5a6;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .emergency-section {
            background: rgba(231, 76, 60, 0.08);
            border: 2px solid #FFCDD2;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .emergency-section h3 {
            color: #D32F2F;
            margin-bottom: 15px;
        }

        .emergency-section p {
            color: #F44336;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .emergency-contacts {
            background: rgba(231, 76, 60, 0.03);
            border-left: 4px solid #F44336;
            padding: 15px;
            margin: 15px 0;
        }

        .emergency-contacts h4 {
            color: #D32F2F;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .emergency-contacts ul {
            list-style: none;
            padding: 0;
        }

        .emergency-contacts li {
            margin: 8px 0;
            padding: 5px 0;
            color: #F44336;
            font-weight: 500;
        }

        .emergency-contacts li strong {
            color: #D32F2F;
        }

        .privacy-section {
            background: rgba(76, 175, 80, 0.08);
            border: 2px solid #C8E6C9;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .privacy-section h3 {
            color: #388E3C;
            margin-bottom: 15px;
        }

        .quote {
            text-align: center;
            font-style: italic;
            color: #7B8FA3;
            margin: 30px 0;
            font-size: 1.1rem;
        }

        body.dark-mode .quote {
            color: #95a5a6;
        }

        .admin-button {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(52, 73, 94, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .admin-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .admin-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .admin-form label {
            font-weight: 600;
            color: #2c3e50;
        }

        body.dark-mode .admin-form label {
            color: #ecf0f1;
        }

        .admin-form input, .admin-form select {
            padding: 12px 15px;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        body.dark-mode .admin-form input, body.dark-mode .admin-form select {
            background: #34495e;
            border-color: #7f8c8d;
            color: #ecf0f1;
        }

        .admin-form input:focus, .admin-form select:focus {
            border-color: #4A90E2;
        }

        .admin-form button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 144, 226, 0.3);
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateY(20px);
            background: rgba(76, 175, 80, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-weight: bold;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            max-width: 80%;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .toast.error {
            background: rgba(244, 67, 54, 0.95);
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) translateY(0);
        }

        /* Footer contatti emergenza */
        .emergency-footer {
            grid-column: 1 / -1;
            background: rgba(231, 76, 60, 0.08);
            border: 2px solid #FFCDD2;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
        }

        .emergency-footer h2 {
            color: #D32F2F;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        .country-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            border-left: 5px solid #F44336;
        }

        body.dark-mode .country-section {
            background: rgba(52, 73, 94, 0.5);
        }

        .country-section h3 {
            color: #D32F2F;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }

        .contact-item {
            background: rgba(231, 76, 60, 0.05);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid rgba(231, 76, 60, 0.2);
            transition: all 0.3s ease;
        }

        .contact-item:hover {
            background: rgba(231, 76, 60, 0.1);
            transform: translateY(-2px);
        }

        .contact-item strong {
            color: #D32F2F;
        }

        /* Scrollbar personalizzata */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(74, 144, 226, 0.6);
            border-radius: 10px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(74, 144, 226, 0.8);
        }

        /* Responsive design migliorato */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .microphone-button {
                width: 100px;
                height: 100px;
                font-size: 2rem;
            }
            
            .chat-section {
                height: 500px;
            }
            
            .message {
                max-width: 90%;
            }

            .contact-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle">🌙</button>
    <div class="status-bar" id="statusBar">⚠️ Modalità Demo</div>
    <button class="admin-button" id="adminBtn">⚙️</button>

    <div class="container">
        <div class="header card">
            <h1>AluIA</h1>
            <p>Supporto psicologico intelligente sempre al tuo fianco</p>
        </div>

        <div class="card">
            <h2 class="section-title">🎤 Comunicazione Vocale</h2>
            <div class="microphone-section">
                <button class="microphone-button" id="microphoneButton">🎤</button>
                <div class="microphone-status" id="microphoneStatus">Microfono sempre attivo</div>
                <div class="transcript-area" id="transcriptArea">La trascrizione in tempo reale apparirà qui...</div>
                
                <div class="microphone-help">
                    <h4>🔓 Come sbloccare il microfono:</h4>
                    <ol>
                        <li>Clicca sull'icona del lucchetto 🔒 nella barra degli indirizzi</li>
                        <li>Trova "Microfono" e cambia in "Consenti"</li>
                        <li>Ricarica la pagina (F5)</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="section-title">💬 Chat con Alu</h2>
            <div class="chat-section">
                <div class="chat-container" id="chatContainer">
                    <div class="message assistant">
                        👋 Ciao! Sono Alu e sono qui per aiutarti. Puoi parlarmi vocalmente premendo il microfono o scrivere qui nella chat. Come posso supportarti oggi?
                    </div>
                    <div class="typing-indicator" id="typingIndicator">
                        <span>Alu sta scrivendo</span>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Scrivi il tuo messaggio...">
                    <button class="send-button" id="sendButton">Invia</button>
                </div>
            </div>
        </div>

        <button class="privacy-button" id="privacyButton">🔒 Privacy & Sicurezza</button>

        <!-- Footer Contatti di Emergenza -->
        <div class="emergency-footer">
            <h2>🆘 CONTATTI DI EMERGENZA</h2>
            
            <div class="country-section">
                <h3>🇮🇹 ITALIA</h3>
                <div class="contact-grid">
                    <div class="contact-item">📞 <strong>Telefono Amico:</strong> 800.833.833</div>
                    <div class="contact-item">🌍 <strong>Dall'estero:</strong> +39 02 20228733</div>
                    <div class="contact-item">🚨 <strong>Numero Unico Emergenza:</strong> 112</div>
                    <div class="contact-item">🛡️ <strong>Antiviolenza e Stalking:</strong> 1522</div>
                    <div class="contact-item">❤️ <strong>Croce Rossa Emergenza Psicologica:</strong> 1520</div>
                </div>
            </div>

            <div class="country-section">
                <h3>🇵🇹 PORTOGALLO</h3>
                <div class="contact-grid">
                    <div class="contact-item">🏥 <strong>SNS 24:</strong> 808 24 24 24 (opzione 4)</div>
                    <div class="contact-item">🆘 <strong>APAV:</strong> 116 006</div>
                    <div class="contact-item">🚨 <strong>Emergenza UE:</strong> 112</div>
                    <div class="contact-item">💚 <strong>SOS Voz Amiga:</strong> 213 544 545</div>
                    <div class="contact-item">🤝 <strong>Conversa Amiga:</strong> 925 512 884</div>
                    <div class="contact-item">📞 <strong>Telefone da Amizade:</strong> 228 323 535</div>
                </div>
            </div>

            <div class="country-section">
                <h3>🇬🇧 REGNO UNITO</h3>
                <div class="contact-grid">
                    <div class="contact-item">🚨 <strong>Emergenze:</strong> 999</div>
                    <div class="contact-item">🛡️ <strong>Domestic Abuse Helpline:</strong> 0808 2000 247</div>
                    <div class="contact-item">💙 <strong>Samaritans:</strong> 116 123</div>
                    <div class="contact-item">👶 <strong>Childline:</strong> 0800 1111</div>
                </div>
            </div>

            <div class="country-section">
                <h3>🇪🇸 SPAGNA</h3>
                <div class="contact-grid">
                    <div class="contact-item">🚨 <strong>Emergenza Generale:</strong> 112</div>
                    <div class="contact-item">🧠 <strong>Supporto Psicologico 24h:</strong> 800 101 800</div>
                    <div class="contact-item">🛡️ <strong>Violenza di Genere:</strong> 016</div>
                    <div class="contact-item">💚 <strong>Telefono della Speranza:</strong> 717 003 717</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div class="modal" id="privacyModal">
        <div class="modal-content">
            <span class="close" id="closePrivacy">&times;</span>
            <h2>🔒 Privacy & Sicurezza</h2>
            
            <div class="emergency-section">
                <h3>🆘 CONTATTI DI EMERGENZA</h3>
                <p>⚠️ IMPORTANTE: AluIA non sostituisce il supporto psicologico professionale.</p>
                <p>In caso di emergenze, contatta immediatamente un professionista qualificato o i servizi di emergenza.</p>
                
                <div class="emergency-contacts">
                    <h4>🇮🇹 Italia:</h4>
                    <ul>
                        <li><strong>Telefono Amico:</strong> 800.833.833</li>
                        <li><strong>Dall'estero:</strong> +39 02 20228733</li>
                        <li><strong>Numero Unico Emergenza:</strong> 112</li>
                        <li><strong>Antiviolenza e Stalking:</strong> 1522</li>
                        <li><strong>Croce Rossa Emergenza Psicologica:</strong> 1520</li>
                    </ul>
                </div>

                <div class="emergency-contacts">
                    <h4>🇵🇹 Portogallo:</h4>
                    <ul>
                        <li><strong>SNS 24:</strong> 808 24 24 24 (opzione 4)</li>
                        <li><strong>APAV:</strong> 116 006</li>
                        <li><strong>Emergenza UE:</strong> 112</li>
                        <li><strong>SOS Voz Amiga:</strong> 213 544 545</li>
                        <li><strong>Conversa Amiga:</strong> 925 512 884</li>
                        <li><strong>Telefone da Amizade:</strong> 228 323 535</li>
                    </ul>
                </div>

                <div class="emergency-contacts">
                    <h4>🇬🇧 Regno Unito:</h4>
                    <ul>
                        <li><strong>Emergenze:</strong> 999</li>
                        <li><strong>Domestic Abuse Helpline:</strong> 0808 2000 247</li>
                        <li><strong>Samaritans:</strong> 116 123</li>
                        <li><strong>Childline:</strong> 0800 1111</li>
                    </ul>
                </div>

                <div class="emergency-contacts">
                    <h4>🇪🇸 Spagna:</h4>
                    <ul>
                        <li><strong>Emergenza Generale:</strong> 112</li>
                        <li><strong>Supporto Psicologico 24h:</strong> 800 101 800</li>
                        <li><strong>Violenza di Genere:</strong> 016</li>
                        <li><strong>Telefono della Speranza:</strong> 717 003 717</li>
                    </ul>
                </div>
            </div>

            <div class="privacy-section">
                <h3>🔒 Privacy Garantita</h3>
                <p><strong>Tutte le conversazioni sono completamente private e sicure.</strong> I tuoi dati non vengono mai condivisi o salvati sui nostri server.</p>
                <ul>
                    <li>✅ Nessun salvataggio permanente delle conversazioni</li>
                    <li>✅ Comunicazione crittografata</li>
                    <li>✅ Nessuna condivisione con terze parti</li>
                    <li>✅ Anonimato garantito</li>
                    <li>✅ Dati processati localmente nel browser</li>
                    <li>✅ Nessun tracking o profilazione</li>
                </ul>
            </div>

            <div class="quote">
                💙 "Quando vuoi, sono qui per ascoltarti sempre." - Alu
            </div>
        </div>
    </div>

    <!-- Admin Config Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <span class="close" id="closeAdmin">&times;</span>
            <h2>⚙️ Configurazione Amministratore</h2>
            <div class="admin-form">
                <label for="apiKey">OpenAI API Key:</label>
                <input type="password" id="apiKey" placeholder="sk-...">
                
                <label for="elevenLabsKey">ElevenLabs API Key (opzionale):</label>
                <input type="password" id="elevenLabsKey" placeholder="sk_...">
                
                <label for="assistantId">Assistant ID (opzionale):</label>
                <input type="text" id="assistantId" placeholder="asst_...">
                
                <label for="voiceId">Voice ID ElevenLabs:</label>
                <select id="voiceId">
                    <option value="">Usa sintesi nativa</option>
                    <option value="21m00Tcm4TlvDq8ikWAM">Rachel (Inglese - Femminile)</option>
                    <option value="AZnzlk1XvdvUeBnXmlld">Domi (Inglese - Femminile)</option>
                    <option value="EXAVITQu4vr4xnSDxMaL">Bella (Inglese - Femminile)</option>
                    <option value="ErXwobaYiN019PkySvjV">Antoni (Inglese - Maschile)</option>
                    <option value="MF3mGyEYCl7XYWbV9V6O">Elli (Inglese - Femminile)</option>
                    <option value="TxGEqnHWrfWFTfGW9XjX">Josh (Inglese - Maschile)</option>
                </select>
                
                <button onclick="window.aluia.saveAdminConfig()">Salva Configurazione</button>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 Avvio AluIA2025 - Versione Finale Completa...');

        class AluIA {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.isProcessing = false;
                this.autoRestartEnabled = true;
                this.restartTimeout = null;
                this.conversationHistory = [];
                this.isDarkMode = localStorage.getItem('aluia_theme') === 'dark';
                this.apiKey = localStorage.getItem('aluia_api_key') || '';
                this.elevenLabsKey = localStorage.getItem('aluia_elevenlabs_key') || '';
                this.assistantId = localStorage.getItem('aluia_assistant_id') || '';
                this.voiceId = localStorage.getItem('aluia_voice_id') || '';
                this.isApiConfigured = this.apiKey.length > 0;
                this.isElevenLabsConfigured = this.elevenLabsKey.length > 0;
                this.microphoneEnabled = true; // Controllo stato microfono
                
                // Fix avanzato per desktop - PROBLEMA MICROFONO RISOLTO
                this.desktopFix = {
                    maxRetries: 5,
                    currentRetries: 0,
                    isDesktop: !this.isMobileDevice(),
                    lastError: null,
                    errorCount: 0,
                    consecutiveErrors: 0,
                    lastSuccessTime: Date.now(),
                    adaptiveDelay: 1500
                };

                this.initElements();
                this.initSpeechRecognition();
                this.initEventListeners();
                this.updateUI();
                this.applyTheme();
                
                // Avvia automaticamente il microfono
                setTimeout(() => {
                    this.startAutoListening();
                }, 1000);
                
                console.log('✅ AluIA2025 Finale inizializzata');
                console.log('🖥️ Desktop detected:', this.desktopFix.isDesktop);
                console.log('🎵 ElevenLabs configured:', this.isElevenLabsConfigured);
                console.log('🎤 Microfono enabled:', this.microphoneEnabled);
                this.showToast('AluIA pronta! Microfono sempre attivo.');
            }

            isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                       (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
            }

            initElements() {
                // Main elements
                this.microphoneButton = document.getElementById('microphoneButton');
                this.microphoneStatus = document.getElementById('microphoneStatus');
                this.transcriptArea = document.getElementById('transcriptArea');
                this.chatContainer = document.getElementById('chatContainer');
                this.chatInput = document.getElementById('chatInput');
                this.sendButton = document.getElementById('sendButton');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.statusBar = document.getElementById('statusBar');
                this.themeToggle = document.getElementById('themeToggle');
                this.adminBtn = document.getElementById('adminBtn');

                // Modal elements
                this.privacyModal = document.getElementById('privacyModal');
                this.adminModal = document.getElementById('adminModal');
                
                console.log('📋 Elementi DOM inizializzati');
            }

            initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'it-IT'; // LINGUA ITALIANA CONFERMATA
                    this.recognition.maxAlternatives = 1;
                    
                    if (this.desktopFix.isDesktop) {
                        try {
                            this.recognition.grammars = new (window.SpeechGrammarList || window.webkitSpeechGrammarList)();
                        } catch (e) {
                            console.log('⚠️ Speech grammars non supportate');
                        }
                    }

                    this.recognition.onstart = () => {
                        console.log('🎤 Riconoscimento vocale avviato');
                        this.isListening = true;
                        this.desktopFix.currentRetries = 0;
                        this.desktopFix.consecutiveErrors = 0;
                        this.desktopFix.lastSuccessTime = Date.now();
                        this.updateMicrophoneUI();
                    };

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        this.transcriptArea.textContent = finalTranscript + interimTranscript;
                        this.transcriptArea.classList.add('has-content');

                        if (finalTranscript.trim()) {
                            console.log('🗣️ Trascrizione finale:', finalTranscript);
                            this.desktopFix.lastSuccessTime = Date.now();
                            this.desktopFix.consecutiveErrors = 0;
                            this.processVoiceInput(finalTranscript.trim());
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('❌ Errore riconoscimento vocale:', event.error);
                        this.desktopFix.lastError = event.error;
                        this.desktopFix.errorCount++;
                        this.desktopFix.consecutiveErrors++;
                        
                        this.handleSpeechErrorAdvanced(event.error);
                    };

                    this.recognition.onend = () => {
                        console.log('🔇 Riconoscimento vocale terminato');
                        this.isListening = false;
                        this.updateMicrophoneUI();

                        // CORREZIONE: Solo riavvia se microfono abilitato
                        if (this.autoRestartEnabled && !this.isProcessing && this.microphoneEnabled) {
                            this.scheduleSmartRestart();
                        }
                    };

                    console.log('✅ Riconoscimento vocale configurato per italiano');
                } else {
                    console.error('❌ Speech Recognition non supportato');
                    this.showToast('Riconoscimento vocale non supportato in questo browser', 'error');
                }
            }

            handleSpeechErrorAdvanced(error) {
                if (this.restartTimeout) {
                    clearTimeout(this.restartTimeout);
                }

                let restartDelay = this.desktopFix.adaptiveDelay;
                let shouldRestart = true;

                if (this.desktopFix.consecutiveErrors > 2) {
                    restartDelay = Math.min(8000, this.desktopFix.adaptiveDelay * Math.pow(1.5, this.desktopFix.consecutiveErrors - 2));
                }

                switch (error) {
                    case 'no-speech':
                        if (this.desktopFix.isDesktop) {
                            restartDelay = Math.min(4000, 2000 + (this.desktopFix.consecutiveErrors * 500));
                        }
                        break;
                        
                    case 'network':
                        if (this.desktopFix.isDesktop) {
                            this.desktopFix.currentRetries++;
                            restartDelay = Math.min(10000, 2000 * Math.pow(2, this.desktopFix.currentRetries - 1));
                            if (this.desktopFix.currentRetries > this.desktopFix.maxRetries) {
                                shouldRestart = false;
                                this.showToast('Problemi di connessione persistenti. Riprova manualmente.', 'error');
                            }
                        }
                        break;
                        
                    case 'aborted':
                        if (this.desktopFix.isDesktop) {
                            restartDelay = Math.min(5000, 2500 + (this.desktopFix.consecutiveErrors * 300));
                        }
                        break;
                        
                    case 'not-allowed':
                        this.autoRestartEnabled = false;
                        shouldRestart = false;
                        this.showToast('Permessi microfono negati. Clicca il microfono per riprovare.', 'error');
                        break;
                        
                    case 'service-not-allowed':
                        if (this.desktopFix.isDesktop) {
                            if (this.desktopFix.consecutiveErrors > 3) {
                                this.autoRestartEnabled = false;
                                shouldRestart = false;
                                this.showToast('Servizio non disponibile. Ricarica la pagina.', 'error');
                            } else {
                                restartDelay = 5000;
                            }
                        }
                        break;
                        
                    case 'audio-capture':
                        if (this.desktopFix.consecutiveErrors > 2) {
                            shouldRestart = false;
                            this.showToast('Problema con il microfono. Controlla le impostazioni.', 'error');
                        } else {
                            restartDelay = 3000;
                        }
                        break;
                        
                    default:
                        if (this.desktopFix.isDesktop && this.desktopFix.consecutiveErrors > 5) {
                            shouldRestart = false;
                            this.showToast('Troppi errori consecutivi. Riprova manualmente.', 'error');
                        }
                }

                const timeSinceSuccess = Date.now() - this.desktopFix.lastSuccessTime;
                if (timeSinceSuccess > 60000 && this.desktopFix.consecutiveErrors > 3) {
                    shouldRestart = false;
                    this.showToast('Microfono inattivo da troppo tempo. Riprova manualmente.', 'error');
                }

                // CORREZIONE: Solo riavvia se microfono abilitato
                if (shouldRestart && this.autoRestartEnabled && this.microphoneEnabled) {
                    this.restartTimeout = setTimeout(() => {
                        if (this.autoRestartEnabled && !this.isListening && this.microphoneEnabled) {
                            console.log(`🔄 Riavvio automatico dopo ${error} (delay: ${restartDelay}ms)`);
                            this.startListening();
                        }
                    }, restartDelay);
                }

                this.isListening = false;
                this.updateMicrophoneUI();
            }

            scheduleSmartRestart() {
                let delay = this.desktopFix.isDesktop ? 2500 : 1500;
                
                if (this.desktopFix.consecutiveErrors > 0) {
                    delay += this.desktopFix.consecutiveErrors * 500;
                }
                
                delay = Math.min(delay, 6000);
                
                this.restartTimeout = setTimeout(() => {
                    if (this.autoRestartEnabled && !this.isListening && !this.isProcessing && this.microphoneEnabled) {
                        console.log('🔄 Riavvio automatico programmato');
                        this.startListening();
                    }
                }, delay);
            }

            initEventListeners() {
                if (this.microphoneButton) {
                    this.microphoneButton.addEventListener('click', () => {
                        this.toggleMicrophone(); // CORREZIONE: Usa la funzione corretta
                    });
                }

                if (this.sendButton) {
                    this.sendButton.addEventListener('click', () => this.sendMessage());
                }

                if (this.chatInput) {
                    this.chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.sendMessage();
                        }
                    });
                }

                if (this.themeToggle) {
                    this.themeToggle.addEventListener('click', () => this.toggleTheme());
                }

                document.getElementById('privacyButton')?.addEventListener('click', () => this.showPrivacyModal());
                document.getElementById('closePrivacy')?.addEventListener('click', () => this.hidePrivacyModal());
                document.getElementById('closeAdmin')?.addEventListener('click', () => this.hideAdminModal());

                document.addEventListener('click', (e) => {
                    if (e.target === this.privacyModal) this.hidePrivacyModal();
                    if (e.target === this.adminModal) this.hideAdminModal();
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hidePrivacyModal();
                        this.hideAdminModal();
                    }
                });

                document.addEventListener('dblclick', (e) => {
                    if (e.target === document.body) {
                        const code = prompt('Codice amministratore:');
                        if (code === 'ALUIA2025') { // CODICE ADMIN CONFERMATO
                            this.adminBtn.style.display = 'block';
                            this.showToast('Modalità amministratore attivata', 'success');
                        }
                    }
                });

                this.adminBtn?.addEventListener('click', () => this.showAdminModal());

                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        console.log('📱 Pagina nascosta, pausa microfono');
                        if (this.isListening) {
                            this.autoRestartEnabled = false;
                            this.stopListening();
                        }
                    } else {
                        console.log('📱 Pagina visibile, riprendi microfono');
                        setTimeout(() => {
                            this.autoRestartEnabled = true;
                            this.desktopFix.consecutiveErrors = 0;
                            if (!this.isListening && this.microphoneEnabled) {
                                this.startListening();
                            }
                        }, 1000);
                    }
                });

                console.log('✅ Eventi configurati');
            }

            async checkMicrophonePermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('✅ Permessi microfono concessi');
                    stream.getTracks().forEach(track => track.stop());
                    return true;
                } catch (error) {
                    console.warn('❌ Impossibile verificare permessi microfono:', error);
                    return false;
                }
            }

            async startAutoListening() {
                console.log('🎤 Richiedendo permessi microfono per avvio automatico...');
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('✅ Permessi microfono concessi per avvio automatico');
                    
                    stream.getTracks().forEach(track => track.stop());
                    
                    const startDelay = this.desktopFix.isDesktop ? 2000 : 1000;
                    setTimeout(() => {
                        if (this.microphoneEnabled) {
                            this.startListening();
                        }
                    }, startDelay);
                } catch (error) {
                    console.error('❌ Permessi microfono negati per avvio automatico:', error);
                    this.showToast('Permessi microfono richiesti per funzionare', 'error');
                }
            }

            startListening() {
                if (this.recognition && !this.isListening && this.microphoneEnabled) {
                    try {
                        if (this.isListening) {
                            this.recognition.stop();
                            const retryDelay = this.desktopFix.isDesktop ? 2500 : 1500;
                            setTimeout(() => {
                                if (!this.isListening && this.microphoneEnabled) {
                                    this.recognition.start();
                                }
                            }, retryDelay);
                        } else {
                            this.recognition.start();
                        }
                    } catch (error) {
                        console.error('❌ Errore avvio riconoscimento:', error);
                        this.desktopFix.consecutiveErrors++;
                        const retryDelay = this.desktopFix.isDesktop ? 3000 : 2000;
                        setTimeout(() => {
                            if (!this.isListening && this.autoRestartEnabled && this.desktopFix.consecutiveErrors < 5 && this.microphoneEnabled) {
                                this.startListening();
                            }
                        }, retryDelay);
                    }
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                    if (this.restartTimeout) {
                        clearTimeout(this.restartTimeout);
                        this.restartTimeout = null;
                    }
                }
            }

            // CORREZIONE COMPLETA: Funzione toggle microfono corretta
            toggleMicrophone() {
                if (this.microphoneEnabled) {
                    // Disabilita il microfono
                    console.log('🔇 Disabilitazione microfono dall\'utente');
                    this.microphoneEnabled = false;
                    this.autoRestartEnabled = false;
                    this.stopListening();
                    this.showToast('Microfono disattivato', 'error');
                } else {
                    // Abilita il microfono
                    console.log('🎤 Riabilitazione microfono dall\'utente');
                    this.microphoneEnabled = true;
                    this.autoRestartEnabled = true;
                    this.desktopFix.currentRetries = 0;
                    this.desktopFix.consecutiveErrors = 0;
                    this.startListening();
                    this.showToast('Microfono attivato', 'success');
                }
                this.updateMicrophoneUI();
            }

            // CORREZIONE: UI microfono con stati corretti
            updateMicrophoneUI() {
                if (!this.microphoneEnabled) {
                    // Microfono disabilitato
                    this.microphoneButton.classList.remove('listening');
                    this.microphoneButton.classList.add('disabled');
                    this.microphoneStatus.textContent = 'Microfono disattivato - Clicca per attivare';
                    this.microphoneStatus.classList.remove('active');
                    this.microphoneStatus.classList.add('disabled');
                } else if (this.isListening) {
                    // Microfono attivo e in ascolto
                    this.microphoneButton.classList.add('listening');
                    this.microphoneButton.classList.remove('disabled');
                    this.microphoneStatus.textContent = 'Microfono attivo - Parla ora';
                    this.microphoneStatus.classList.add('active');
                    this.microphoneStatus.classList.remove('disabled');
                } else {
                    // Microfono abilitato ma non in ascolto
                    this.microphoneButton.classList.remove('listening', 'disabled');
                    this.microphoneStatus.textContent = 'Microfono sempre attivo';
                    this.microphoneStatus.classList.remove('active', 'disabled');
                }
            }

            processVoiceInput(text) {
                console.log('🎙️ Elaborazione input vocale:', text);
                this.isProcessing = true;
                this.addMessage(text, 'user');
                this.sendToAssistant(text);
                
                setTimeout(() => {
                    this.isProcessing = false;
                }, 3000);
            }

            addMessage(content, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = content;
                
                this.chatContainer.appendChild(messageDiv);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                
                console.log(`💬 Messaggio aggiunto (${type}):`, content);
            }

            sendMessage() {
                const message = this.chatInput.value.trim();
                if (message) {
                    this.addMessage(message, 'user');
                    this.sendToAssistant(message);
                    this.chatInput.value = '';
                }
            }

            async sendToAssistant(message) {
                this.showTyping();
                
                try {
                    this.conversationHistory.push({
                        role: 'user',
                        content: message
                    });

                    let response;
                    
                    if (window.location.hostname.includes('claude.ai') || !this.isApiConfigured) {
                        response = this.getDemoResponse(message);
                    } else {
                        const apiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`
                            },
                            body: JSON.stringify({
                                model: 'gpt-4',
                                messages: [
                                    {
                                        role: 'system',
                                        content: 'Sei Alu, un assistente di supporto psicologico empatico e professionale. Rispondi sempre in italiano con calore e comprensione. Mantieni le risposte concise ma significative (massimo 150 parole). Se rilevi situazioni di emergenza, suggerisci di contattare professionisti qualificati. Usa un tono caldo e rassicurante.'
                                    },
                                    ...this.conversationHistory.slice(-10)
                                ],
                                max_tokens: 400,
                                temperature: 0.7
                            })
                        });

                        if (!apiResponse.ok) {
                            throw new Error(`API Error: ${apiResponse.status}`);
                        }

                        const data = await apiResponse.json();
                        response = data.choices[0].message.content;
                    }

                    this.conversationHistory.push({
                        role: 'assistant',
                        content: response
                    });

                    this.hideTyping();
                    this.addMessage(response, 'assistant');
                    
                    // ELEVENLABS INTEGRATO MA NASCOSTO
                    if (this.isElevenLabsConfigured && this.voiceId) {
                        await this.speakWithElevenLabs(response);
                    } else {
                        this.speakWithNativeTTS(response);
                    }
                    
                    if (this.conversationHistory.length > 40) {
                        this.conversationHistory = this.conversationHistory.slice(-20);
                    }

                } catch (error) {
                    console.error('❌ Errore invio messaggio:', error);
                    this.hideTyping();
                    
                    const demoResponse = this.getDemoResponse(message);
                    this.addMessage(demoResponse, 'assistant');
                    
                    if (this.isElevenLabsConfigured && this.voiceId) {
                        await this.speakWithElevenLabs(demoResponse);
                    } else {
                        this.speakWithNativeTTS(demoResponse);
                    }
                }
            }

            // ELEVENLABS COMPLETAMENTE NASCOSTO
            async speakWithElevenLabs(text) {
                if (!this.isElevenLabsConfigured || !this.voiceId) return;
                
                try {
                    console.log('🎵 Sintesi vocale ElevenLabs (nascosta)');
                    
                    const cleanText = text.replace(/[🔥💙✅❌⚠️🆘🎤💬🔒]/g, '').trim();
                    
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${this.voiceId}`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'audio/mpeg',
                            'Content-Type': 'application/json',
                            'xi-api-key': this.elevenLabsKey
                        },
                        body: JSON.stringify({
                            text: cleanText,
                            model_id: 'eleven_multilingual_v2',
                            voice_settings: {
                                stability: 0.6,
                                similarity_boost: 0.7,
                                style: 0.4,
                                use_speaker_boost: true
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`ElevenLabs API Error: ${response.status}`);
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    
                    audio.volume = 0.8;
                    
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    audio.onerror = () => {
                        console.error('❌ Errore riproduzione audio ElevenLabs');
                        URL.revokeObjectURL(audioUrl);
                        this.speakWithNativeTTS(text);
                    };
                    
                    await audio.play();
                    console.log('✅ Audio ElevenLabs riprodotto (nascosto)');
                    
                } catch (error) {
                    console.error('❌ Errore ElevenLabs:', error);
                    this.speakWithNativeTTS(text);
                }
            }

            speakWithNativeTTS(text) {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'it-IT'; // LINGUA ITALIANA CONFERMATA
                    utterance.rate = 0.85;
                    utterance.pitch = 1.1;
                    utterance.volume = 0.8;
                    
                    const voices = speechSynthesis.getVoices();
                    const italianVoice = voices.find(voice => voice.lang.startsWith('it'));
                    if (italianVoice) {
                        utterance.voice = italianVoice;
                    }
                    
                    utterance.onerror = (event) => {
                        console.error('❌ Errore sintesi vocale nativa:', event.error);
                    };
                    
                    speechSynthesis.speak(utterance);
                    console.log('🔊 Sintesi vocale nativa utilizzata (italiano)');
                }
            }

            // RISPOSTE DEMO IN ITALIANO
            getDemoResponse(message) {
                const responses = [
                    "Ti ascolto e capisco quello che stai vivendo. È normale sentirsi così a volte.",
                    "Grazie per aver condiviso questo con me. Come ti senti ora dopo averlo espresso?",
                    "Quello che provi è valido e importante. Vuoi parlarmi di più di questa situazione?",
                    "Ti sono vicina in questo momento. Ricorda che non sei solo in questo percorso.",
                    "È un passo importante quello di parlarne. Come posso aiutarti a sentirti meglio?",
                    "Comprendo la tua preoccupazione. Insieme possiamo trovare delle strategie per affrontarla.",
                    "Le tue emozioni sono importanti. Prenditi il tempo che ti serve per elaborarle.",
                    "Sono qui per ascoltarti senza giudicare. Cosa ti passa per la mente in questo momento?",
                    "Capisco che possa essere difficile. Vuoi provare a respirare insieme per qualche minuto?",
                    "La tua esperienza è unica e preziosa. Come posso supportarti meglio oggi?"
                ];

                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('suicid') || lowerMessage.includes('morte') || lowerMessage.includes('farla finita')) {
                    return "Mi preoccupo molto per te. È fondamentale che tu parli immediatamente con un professionista qualificato. Contatta il tuo medico, un centro di salute mentale o i servizi di emergenza. La tua vita ha un valore immenso e ci sono persone pronte ad aiutarti. 🆘";
                }
                
                if (lowerMessage.includes('panico') || lowerMessage.includes('ansia') || lowerMessage.includes('attacco')) {
                    return "Capisco che stai attraversando un momento molto difficile. Proviamo insieme: inspira lentamente per 4 secondi, trattieni il respiro per 4, poi espira per 6 secondi. Ripeti questo ciclo. Se gli attacchi sono frequenti, è importante consultare un professionista. Sono qui con te. 💙";
                }

                if (lowerMessage.includes('solo') || lowerMessage.includes('abbandon') || lowerMessage.includes('isolat')) {
                    return "Non sei davvero solo, anche se ora può sembrare così. I sentimenti di solitudine sono dolorosi ma temporanei. Ci sono persone che si preoccupano per te, anche se non sempre è evidente. Vuoi parlare di cosa ti fa sentire più isolato?";
                }

                return responses[Math.floor(Math.random() * responses.length)];
            }

            showTyping() {
                this.typingIndicator.style.display = 'flex';
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            hideTyping() {
                this.typingIndicator.style.display = 'none';
            }

            updateUI() {
                if (this.isElevenLabsConfigured && this.isApiConfigured) {
                    this.statusBar.textContent = '✅ Alu Pronta (AI + Voice)';
                    this.statusBar.className = 'status-bar elevenlabs';
                } else if (this.isApiConfigured) {
                    this.statusBar.textContent = '✅ Alu Pronta (API)';
                    this.statusBar.className = 'status-bar connected';
                } else {
                    this.statusBar.textContent = '⚠️ Modalità Demo';
                    this.statusBar.className = 'status-bar';
                }
            }

            applyTheme() {
                if (this.isDarkMode) {
                    document.body.classList.add('dark-mode');
                    this.themeToggle.textContent = '☀️';
                } else {
                    document.body.classList.remove('dark-mode');
                    this.themeToggle.textContent = '🌙';
                }
            }

            toggleTheme() {
                this.isDarkMode = !this.isDarkMode;
                localStorage.setItem('aluia_theme', this.isDarkMode ? 'dark' : 'light');
                this.applyTheme();
                this.showToast(`Tema ${this.isDarkMode ? 'scuro' : 'chiaro'} attivato`);
            }

            showPrivacyModal() {
                this.privacyModal.style.display = 'block';
            }

            hidePrivacyModal() {
                this.privacyModal.style.display = 'none';
            }

            showAdminModal() {
                document.getElementById('apiKey').value = this.apiKey;
                document.getElementById('elevenLabsKey').value = this.elevenLabsKey;
                document.getElementById('assistantId').value = this.assistantId;
                document.getElementById('voiceId').value = this.voiceId;
                this.adminModal.style.display = 'block';
            }

            hideAdminModal() {
                this.adminModal.style.display = 'none';
            }

            saveAdminConfig() {
                const apiKey = document.getElementById('apiKey').value.trim();
                const elevenLabsKey = document.getElementById('elevenLabsKey').value.trim();
                const assistantId = document.getElementById('assistantId').value.trim();
                const voiceId = document.getElementById('voiceId').value.trim();
                
                if (apiKey && !apiKey.startsWith('sk-')) {
                    this.showToast('OpenAI API Key non valida (deve iniziare con sk-)', 'error');
                    return;
                }
                
                if (elevenLabsKey && !elevenLabsKey.startsWith('sk_')) {
                    this.showToast('ElevenLabs API Key non valida (deve iniziare con sk_)', 'error');
                    return;
                }
                
                this.apiKey = apiKey;
                this.elevenLabsKey = elevenLabsKey;
                this.assistantId = assistantId;
                this.voiceId = voiceId;
                
                localStorage.setItem('aluia_api_key', this.apiKey);
                localStorage.setItem('aluia_elevenlabs_key', this.elevenLabsKey);
                localStorage.setItem('aluia_assistant_id', this.assistantId);
                localStorage.setItem('aluia_voice_id', this.voiceId);
                
                this.isApiConfigured = this.apiKey.length > 0;
                this.isElevenLabsConfigured = this.elevenLabsKey.length > 0;
                
                this.updateUI();
                this.hideAdminModal();
                
                let message = 'Configurazione salvata!';
                if (this.isApiConfigured && this.isElevenLabsConfigured) {
                    message += ' OpenAI + ElevenLabs attivati.';
                } else if (this.isApiConfigured) {
                    message += ' OpenAI attivato.';
                } else if (this.isElevenLabsConfigured) {
                    message += ' ElevenLabs attivato.';
                }
                
                this.showToast(message, 'success');
                console.log('✅ Configurazione salvata');
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
                
                console.log(`📢 Toast: ${message}`);
            }
        }

        // Avvia AluIA quando la pagina è caricata
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM caricato, inizializzando AluIA2025 Finale...');
            window.aluia = new AluIA();
        });

        // Funzioni di test e debug
        window.testMic = () => {
            console.log('🧪 Test microfono...');
            if (window.aluia) {
                window.aluia.toggleMicrophone();
            }
        };

        window.testChat = () => {
            console.log('🧪 Test chat...');
            if (window.aluia) {
                window.aluia.chatInput.value = "Ciao Alu, questo è un test";
                window.aluia.sendMessage();
            }
        };

        window.debugMic = () => {
            console.log('🔍 Debug microfono:');
            console.log('- Recognition:', window.aluia?.recognition);
            console.log('- isListening:', window.aluia?.isListening);
            console.log('- microphoneEnabled:', window.aluia?.microphoneEnabled);
            console.log('- isProcessing:', window.aluia?.isProcessing);
            console.log('- autoRestartEnabled:', window.aluia?.autoRestartEnabled);
            console.log('- Desktop fix:', window.aluia?.desktopFix);
            console.log('- ElevenLabs configured:', window.aluia?.isElevenLabsConfigured);
        };

        window.resetMic = () => {
            console.log('🔄 Reset completo microfono...');
            if (window.aluia) {
                window.aluia.microphoneEnabled = true;
                window.aluia.autoRestartEnabled = true;
                window.aluia.stopListening();
                window.aluia.desktopFix.currentRetries = 0;
                window.aluia.desktopFix.consecutiveErrors = 0;
                window.aluia.desktopFix.errorCount = 0;
                setTimeout(() => {
                    window.aluia.startListening();
                    window.aluia.showToast('Microfono resettato', 'success');
                }, 2000);
            }
        };

        console.log('✅ Script AluIA2025 FINALE caricato. Comandi disponibili:');
        console.log('- testMic(): Testa il microfono');
        console.log('- testChat(): Testa la chat');
        console.log('- debugMic(): Debug stato microfono');
        console.log('- resetMic(): Reset completo microfono');
        console.log('- Codice admin: ALUIA2025 (doppio click su sfondo)');
        console.log('🎯 VERSIONE FINALE COMPLETA - Tutti i bug risolti!');
    </script>

</body>
</html>

